---
title: "dbtを使ったテーブル合致検証" # 記事のタイトル
emoji: "🛠️" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["database","sql","dbt","bigquery"] # タグ。["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---

## サマリ

データパイプラインの開発をしていると、出力されたテーブルが合致することを確認したいことがあります。例えば、既存のクエリの書き方が悪く性能劣化を起こしている場合には、性能を改善するためにクエリを書き換えますが、書き換えたクエリに誤りがないか確認する必要があります。  


## モチベーション

データパイプラインの開発をしていると、出力されたテーブルが合致することを確認したいことがあります。  
例えば、既存のクエリの書き方が悪く性能劣化を起こしている場合には、性能を改善するためにクエリを書き換えますが、書き換えたクエリに誤りがないか確認する必要があります。このような場合、同一のデータソースに対して、新旧両方のクエリを実行し、出力されたテーブルが完全合致することを確認するのが有効です。

また、完全合致ではなく。部分合致するかを確認したいケースも存在します。  
例えば、既存クエリのCASE文の判定に誤りがあり、一部のカラムの値が間違っている場合は、CASE文の処理を修正しますが、そのほかのカラムに悪影響が出ていないか確認する必要があります。このような場合、やはり同一のデータソースに対して、新旧両方のクエリを実行し、出力されたテーブルを比較することになります。  
当然、完全合致しないので、下図のように一部のカラムを除いたテーブルが合致するかを確認すると思います。

このような確認作業を、データパイプラインを保守されている方は日常的に実施します。  
この記事では dbt によって 上記検証作業をCI上で実行できる仕組みを紹介します。  

## アプローチ
こんな感じで作ってます

## 実施結果
こんな感じでチェックできてます

# まとめ
この記事では、こんなことを作って試しました。