---
title: "SQLを書き換えることなく、既存のデータパイプラインにdbtを導入する方法" # 記事のタイトル
emoji: "🛠️" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["database","sql"] # タグ。["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---

# DBT の機能はいいとこどりできる
DBTは全部入れないとダメだと思ってる？実はちょっとだけ導入できるよ

# データパイプラインの王道
データパイプラインにはこんな課題がつきものだよ

- データに重複や欠損を含んでいるのに気が付かず、集計してしまった。
- 不要なテーブルを削除したら、テーブルを参照していたレポートが使えなくなり、クレームが来た。
- データマートの集計処理がしばらく失敗していたが、それに気が付けず、ユーザーからのクレームで発覚した。
- テーブルやカラムの説明が無いため、使って良いデータなのかわからない
- テーブルにうっかり個人情報が含まれていたが、気が付かず公開してしまった
- リリース後のユーザー数が増えていたが、実はリリースに伴って分析用のテーブルが重複しており、数値をかさ増ししていただけだった
- どこにどんなデータがあるかが分からず、分析したくてもできない

このあたりの課題と対策は、ベスプラが割と確立されてきたよ
例えばDMBOKが有名だよ。データ基盤の運用に関係する部分を抽出するよ。

|項目|具体的な打ち手|
|-|-|
|データアーキテクチャ|どんなデータが、どんな業務で使われているのかをわかるようにする。例えば、データがどこからやってきてどこで使われているのかを図示しておく。|
|データ統合と相互運用性(ETL)|決まったタイミングでデータを更新・提供する。データ連係に失敗したらアラートを出して、アクションを取れるようにする|
|データモデリングとデザイン|テーブル同士の参照や包含などの情報をメタデータとして記録する|
|データセキュリティ|セキュリティレベルを定義して、メタデータとして記録する|
|データ品質|高品質なデータを定義して、品質を常にチェック・モニタリングする|
|メタデータ管理|様々なデータのメタデータは一箇所に集める。その上で、標準的なアクセス方法を提供し、メタデータの品質と鮮度を保つ|

対策としては明確なんだけど、いざ実践しようと思うと手間がかかるよ。
例えばデータの品質チェックは、毎日誰かがデータ連係が終わったらテーブルの件数をチェックするなんてできないと思うよ。
データのアーキテクチャも、作ったあとは更新されずに放置されやすいよ。
何かしらのツールをつかないと、目的を達成することは不可能だよ。

# データパイプラインの概念 と dbt がカバーする機能
dbt はパイプラインのベスプラを実現するほとんどの機能を提供してるよ

|項目|具体的な打ち手|dbt の提供する機能例
|-|-|-|
|データアーキテクチャ|どんなデータが、どんな業務で使われているのかをわかるようにする。例えば、データがどこからやってきてどこで使われているのかを図示しておく。|データパイプライン図を自動生成してくれます。|
|データ統合と相互運用性(ETL)|決まったタイミングでデータを更新・提供する。データ連係に失敗したらアラートを出して、アクションを取れるようにする|dbt独自の言語でETLを定義すると、指定したワークフローで実行してくれます。ワークフローに失敗した場合は slack 等への通知が可能です。
|データモデリングとデザイン|テーブル同士の参照や包含などの情報をメタデータとして記録する|テーブル、カラムに対して、リレーションや制約を定義し、定義した内容を満たしているかチェックできます。|
|データセキュリティ|セキュリティレベルを定義して、メタデータとして記録する|メタデータにPIIのような独自タグを定義できます。|
|データ品質|高品質なデータを定義して、品質を常にチェック・モニタリングする|ユニーク制約や not null など、事前に定義したルールを満たしているか、実テーブルに対してチェックを実行できます。ルールは dbt が多数のマクロを用意している上、ユーザーで定義することもできます。|
|メタデータ管理|様々なデータのメタデータは一箇所に集める。その上で、標準的なアクセス方法を提供し、メタデータの品質と鮮度を保つ|クエリ、テスト、スキーマ定義、実テーブルなどから
自動でメタデータ情報を生成します。生成したメタデータ情報は静的サイトとして公開することができ、ブラウザからアクセスして閲覧できます|

dbt はこのように、データ基盤の運用をするのに便利なツールです。
一方で、この機能の全てを引き出そうとすると、独自の記法でクエリを書く前提なので、できないと思われがちだよ

でも、そんなことないよ



# クエリを記載せずに導入できる dbt の機能
クエリを書き換えなくても以下のことはできるよ

*ここに表を入れる*

# 導入方法例
## 既存のBQテーブルに対してテストを行う
## メタデータのドキュメントを生成し、メタデータ閲覧のサービスを公開する

# 部分的な導入によるメリット
dbt は現時点ではツールで、データ基盤運用のQCDを向上できるよ
とはいえ移行するのはコストもかかるしリスクも大きいよ
まずは一部の機能だけをクイックに導入して、信頼を勝ち取った後に、予算を獲得して移行に踏み切るという作戦も有効だと思うよ

# まとめ
データパイプラインに必要な要素を説明し、dbtで解決できることを示したよ。
dbtに移行するのが難しい場合に、dbtの試験とメタデータ機能だけを導入する方法を提案したよ

# 参考文献
https://zenn.dev/takimo/articles/401a8985b6b6fc

DMBOKにあるデータマネジメントの観点と、具体的な打ち手の例
|項目|具体的な打ち手|
|-|-|
|データアーキテクチャ|どんなデータが、どんな業務で使われているのかをわかるようにする。例えば、データがどこからやってきてどこで使われているのかを図示しておく|
|データストレージとオペレーション|早くて気軽な分析用途にはDWHを、しっかりと記録したい場合はRDBを使う|
|データ統合と相互運用性(ETL)|決まったタイミングでデータを更新・提供する。データ連係に失敗したらアラートを出して、アクションを取れるようにする|
|データモデリングとデザイン|テーブル同士の参照や包含などの情報をメタデータとして記録する|
|マスターデータ管理|信頼できる統一されたマスタデータを作って、組織横断で共有できるようにする|
|ドキュメントとコンテンツ管理|ドキュメントをまとめた一覧を作って、探せるようにする|
|データセキュリティ|セキュリティレベルを定義して、メタデータとして記録する|
|データ品質|高品質なデータを定義して、品質を常にチェック・モニタリングする|
|データウェアハウジングとビジネスインテリジェンス|データを統合し、蓄積した上で、誰でも理解できる形に可視化したレポートを提供する|
|メタデータ管理|様々なデータのメタデータは一箇所に集める。その上で、標準的なアクセス方法を提供し、メタデータの品質と鮮度を保つ|
|データガバナンス|上記の内容を徹底するためのルールと計画を作る|
