---
title: "tableauで時間的変化の見える散布図を作る" # 記事のタイトル
emoji: "📈" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["BigQuery","Tableau"] # タグ。["markdown", "rust", "aws"]のように指定する
published: true # 公開設定（falseにすると下書き）
---

# 時系列と相関の両方を一つのグラフで把握する

- 利益率と在庫台数の相関がどうなっているのかを把握したい。
- しかも、在庫台数の推移も同時に見たい。
- 商品のカテゴリ別に見たい。

これらの要望を一発で叶える方法として、以下のようなグラフを作成するという手段があります。

![](/images/scatter-plot-with-time-series.png)
https://public.tableau.com/views/scatter-plot-with-time-series/sample?:language=ja-JP&:display_count=n&:origin=viz_share_link

tableau では、 `ページ` を利用して、 `履歴の表示` をつけると作成できます。
この表現方法をご紹介します。

# モチベーション
## ビジネスの分析には時間的な変化が大事
分析とは

1. 現状を分析し、何かしらのアクションを起こす
2. アクションを起こした結果、良くなったのかどうかを振り返る
3. 振り返りに基づいて、次のアクションを起こす

という作業の繰り返しです。
つまり、アクションを起こす前と後で、時系列で比較して分析することが必須です。

## ビジネスの分析には相関が大事
事業の指標には、売上高などの遅行指標と、広告キャンペーン数などの先行指標があります。  
事業の目的は常に売上、つまり遅行指標を上げることですが、売上を直接上げるようなアクションはありません。
大抵は先行指標に寄与するアクションが行われます。例えば、お客さんをたくさん呼ぶために、割引キャンペーンをたくさん打ち出す、などです。
そのため、アクションで変化しやすい先行指標と、本来の目的である遅行指標との相関を見る、という要望はたくさんあります。
## 時間的な変化と相関の両方を見たい
時間的な変化と、相関の両方を見たい場合、下図のような線グラフを作る方が多いと思います。
![](/images/line-plot-sample.png)
しかし、この図は以下の欠点があります。

- 相関を理解しずらい
- 項目(=椅子/家具など)が増えると読みづらい
- どの項目が悪化/改善しているのか把握しずらい

上記の不満を改善するならやはり散布図です。しかし、普通の散布図は過去のデータが表示されないので、プロットされた点がどのように動いてきたかを把握できるようにする必要があります。

# 解決策
## 散布図のプロットの動きを残像に残す

tableau を使うと、動きのある散布図を作ることができます。
`ページ`という機能を使うことで、年次の断面で散布図を表示できるのですが、`履歴の表示`をチェックすると、過去数年分のプロットの動きを線でつないで表現できます。

具体的な手順は以下です。

![](/images/page-image.png)

![](/images/plot-history.png)

1. 時系列のフィールドを `ページ` に置く
1. `履歴の表示` をチェック
1. `次の履歴を表示するマーク` で `すべて` を選択
1. `表示` で `両方` を選択
1. `マーク`の `サイズ` に時系列のフィールドを追加

これを使うと、冒頭に挙げたような、各項目の利益と数量がどのように推移したのかがわかるようになります。例えは、椅子は2013~2015は数量の増加に伴って利益も伸びていますが、2016は数量が増えているにも関わらず大きく悪化しているため、数量ではなく利益率を改善するアクションを取るべき、といったことが考えられます。
他にも、

- 椅子とテーブルのどちらも「昨年に比べて悪化」しているが、椅子の方が圧倒的に数も利益もオーダーが大きいので、より重点を置くべきとわかる
- 椅子はもっとも成長していたサブカテゴリなのにも関わらず、利益が悪化していることがわかる。
- 本棚は、唯一左下の方向に動いており、数量も利益も下がっている。

といったことが一度にわかるようになります。

# まとめ
時間的な変化と、相関の両方を見たいという分析要望は数多くあるのですが、excelなどの簡易的な可視化では、棒グラフ/線グラフを縦に並べるのが精一杯でした。
相関と時系列の変化をより瞬時に把握するのであれば、散布図に動きを持たせるというのも一案だと思います。
データ可視化で悩んだ際は、参考にしてみてください。